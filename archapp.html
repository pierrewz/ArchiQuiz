<!-- DOCTYPE HTML -->
<html>
<head>
<title>Your First React Project</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div id="content"></div>
<script src="https://fb.me/react-0.14.6.js"></script>
<script src="https://fb.me/react-dom-0.14.6.js"></script>
<script src="https://fb.me/JSXTransformer-0.12.2.js"></script>
<script type="text/jsx">

/*Add your React code here*/

	var DATA = {
		labels:["Name","Location","Architect"],
		questions:[
			{
				photoTitle:"The Statue of Liberty",
				photoURL:"http://lorempixel.com/200/200/a",
				answers:[{label:"Name",value:"The Statue of Liberty"},{label:"Location",value:"New York"}]
			},
			{
				photoTitle:"Eiffel Tower",
				photoURL:"http://lorempixel.com/200/200/a",
				answers:[{label:"Name",value:"Eiffel Tower"},{label:"Location",value:"Paris"},{label:"Architect",value:"Gustav Eiffel"}]
			},
			{
				photoTitle:"Big Ben",
				photoURL:"http://lorempixel.com/200/200/a",
				answers:[{label:"Name",value:"Big Ben"},{label:"Location",value:"London"},{label:"Architect",value:"Archi"}]
			},
			{
				photoTitle:"Burj Dubai",
				photoURL:"http://lorempixel.com/200/200/a",
				answers:[{label:"Name",value:"Burj Dubai"},{label:"Location",value:"Dubai"}]
			}
		]
	};
	
	function verifyAnswer (proposal, answer){
		var correct = false;
		if(proposal.toUpperCase() == answer.toUpperCase()){
			correct = true;
		}
		return correct
	};
	
	function findAnswer(table,index,l) { 
		return table.label == l;
	}

	function getRandomIntInclusive(min, max) {
		min = Math.ceil(min);
		max = Math.floor(max);
		return Math.floor(Math.random() * (max - min + 1)) + min;
	};
	
	function shuffle(array) {
	  var currentIndex = array.length, temporaryValue, randomIndex;

	  // While there remain elements to shuffle...
	  while (0 !== currentIndex) {

		// Pick a remaining element...
		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex -= 1;

		// And swap it with the current element.
		temporaryValue = array[currentIndex];
		array[currentIndex] = array[randomIndex];
		array[randomIndex] = temporaryValue;
	  }

	  return array;
	}
	
		
		
	var App = React.createClass({
		getInitialState: function() {
			return {
			  points: 0,
			  questionid:0,
			  quizcompleted:false
			}
		},
		
		changePoints: function(newpoints){
			if((this.state.points + newpoints) > 0){
				this.setState({points: this.state.points + newpoints})
				return true;
			} else {
				return false;
			}
		},
		
		showNext: function(){
			if (this.state.questionid + 1 >=  this.props.profileData.questions.length){
				this.setState({quizcompleted: true});
			} else {
				this.setState({questionid: this.state.questionid + 1});
			}
		},
		
		prepareRandomAnswers(label){
			var currentQuestion = this.props.profileData.questions[this.state.questionid].answers;
			var correctAnswer = currentQuestion.find(function(obj){
				return obj.label === label;
			}).value;

			var arr = [correctAnswer];
			while(arr.length < 2){
				var r = getRandomIntInclusive(0,this.props.profileData.questions.length-1);
				var result = this.props.profileData.questions[r].answers.find(function(obj){
					return obj.label === label;
				});
				if(arr.indexOf(result.value) > -1) continue;
				arr[arr.length] = result.value;
			}
			arr = shuffle(arr);
			return arr;
		},
		
		render: function(){
			var question = this.props.profileData.questions[this.state.questionid];

			return (
				<div>	
					<Points points={this.state.points}/>
					{ (this.state.quizcompleted) ? <Completed /> : <QuestionContainer key={this.state.questionid} question={question} changePoints={this.changePoints} showNext={this.showNext} prepareRandomAnswers={this.prepareRandomAnswers}/>}
					</div>
			);
		}
	});
	
	var Points = React.createClass({
		
		render: function(){
			return (
				<div>{this.props.points} <img src="blueprint.png" /> </div>
			)
		}
	});
	
	
		
	var QuestionContainer = React.createClass({
		getInitialState: function() {
			return {
				solvedAnswers : [""],
				showHelp: [""]
			}
		},
		
		setAnswerSolved: function(label){
			
			var arrayvar = this.state.solvedAnswers.slice();
			arrayvar.push(label);
			this.setState({ solvedAnswers: arrayvar });
			
		},		
		
		showHelpOptions: function(label){
			if(this.props.changePoints(-10)){
				var arrayvar = this.state.showHelp.slice();
				arrayvar.push(label);
				this.setState({ showHelp: arrayvar });
			} else {
				alert("Not enough blueprints!");
			}
		},
		
				
		render: function(){
			
			var answersList = this.props.question.answers.map(answer => {

				(this.state.solvedAnswers.indexOf(answer.label) >= 0) ? solved = true : solved = false;
				(this.state.showHelp.indexOf(answer.label) >= 0) ? showHelp = true : showHelp = false;
				if(!showHelp || solved){
					var answerDisplay = <Answer key={answer.label} answer={answer} changePoints={this.props.changePoints} solved={solved} setAnswerSolved={this.setAnswerSolved} showHelpOptions={this.showHelpOptions}/>;
				} else {
					var proposalsArray = this.props.prepareRandomAnswers(answer.label);
					var answerDisplay = <Proposal key={answer.label} answer={answer} proposalsArray={proposalsArray} changePoints={this.props.changePoints} setAnswerSolved={this.setAnswerSolved}/>;
				}
				return answerDisplay;
			});
			
			return (
				<div>
					<Photo 
						photoTitle={this.props.question.photoTitle}
						photoURL={this.props.question.photoURL}/>
						{answersList}
						{ (this.state.solvedAnswers.length >  this.props.question.answers.length) ? <NextQuestion showNext={this.props.showNext}/>: null }
				</div>
			);
		}
	})
	
	var Photo = React.createClass({
		render: function(){
			return (
				<div>
					<h3>{this.props.photoTitle}</h3>
					<img src={this.props.photoURL} />
				</div>
			);
		}
	});
	
	
	var Answer = React.createClass({
		getInitialState: function() {
			return {
			  value: ""
			}
		},
		
		handleChange: function(event) {
			this.setState({value: event.target.value});
			if(verifyAnswer(event.target.value, this.props.answer.value)){
				this.props.changePoints(20);
				this.setState({value: this.props.answer.value});
				this.props.setAnswerSolved(this.props.answer.label);
			}
		},
		
		onClickHelp: function(event){
			this.props.showHelpOptions(this.props.answer.label);
		},
		
		render: function(){
			var className = "answerField";
			var inputValue = this.state.value;
			if (this.props.solved) {
			  className += " solved";
			  inputValue = this.props.answer.value;
			}
			return (
				<div>
					<label>{this.props.answer.label}:
					<input type="text" value={inputValue} onChange={this.handleChange} disabled={this.props.solved} className={className}/>
					</label>
					{ (!this.props.solved) ? <input type="submit" value="Help" onClick={this.onClickHelp}/>: null }

				</div>
			);
		}
		
	});
	
	
	var Proposal = React.createClass({
	
		onClickProposal: function(event){
			if(verifyAnswer(event.target.value, this.props.answer.value)){
				this.props.changePoints(10);
			} 
			this.props.setAnswerSolved(this.props.answer.label);
		},
			
		render: function(){
			const proposals = this.props.proposalsArray.map((prop) =>
				<input type="submit" key={prop} value={prop} onClick={this.onClickProposal}/>
			);
			return (
				<div>
					{proposals}
				</div>
			);
		}
	});
	
	
	var NextQuestion = React.createClass({
		onClickNext: function(event){
			this.props.showNext();
		},
		
		render: function(){
			return (
			<input type="submit" value="Next" onClick={this.onClickNext}/>
			);
		}
	})
	
	var Completed = React.createClass({
		
		render: function(){
			return (
				<div>Congratulations! You have finished this quiz.</div>
			)
		}
	});
	
	ReactDOM.render(<App profileData={DATA} />,document.getElementById('content'));
</script>
</body>
</html>